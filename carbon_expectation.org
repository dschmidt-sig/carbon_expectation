* Preface
- starting <2026-01-16 Fri>
- this compares the effects of the original simplistic wildfire probability method vs. Val's Poisson process method on the calculated values of expected carbon stocks and FMU
- this uses the Yuba RCD project because it is a special case in that its mean ABP is high enough that the expected FRI is < 40 years, which complicates the original method
- why don't the Poisson process probabilities sum to exactly 1 at each timestep? they do now, with the correct implementation and a better approximation method (plus normalization)
- the code below retains the basic process defined in CF's quantification spreadsheet for clarity rather than using more efficient formulations
- this is only a small portion of the REM accounting steps!; it only includes what is needed to isolate the effects of compensating for foregone C sequestration due to wildfires
- there could be some timestep alignment issues at the boundaries due to how the timesteps are defined
- I haven't yet looked into using Simpson's 1/3 rule for approximating the expectation integral; this uses the trapezoidal approximation in Val's writeup
* Results
- gross FMU value for Yuba with current method (no foregone C seq): 5,837 (not calculated here)
- gross FMU value for Yuba with simplistic WF foregone C seq method: 14,444
- gross FMU value for Yuba with Poisson process WF foregone C seq method: 12,542 (12,542 w/o normalization)
* Code
#+begin_src python :results output :tangle carbon_expectation.py :comments link
import pandas as pd
import numpy as np

pd.set_option("display.max_columns", 20)
pd.set_option("display.width", 500)

###########################################
# input data specific to the Yuba project #
###########################################
net_emissions = np.array([1221, 1355, 3394, 5905, 9539, 12300, 15618, 18891]) # 8 timesteps (year 5 ... 40)

# carbon stocks from FVS simulations; columns are simulation timesteps, rows are wildfire years; the values where wildfire timestep > sim timestep are not needed
c_b_df = pd.DataFrame({"WF": ["NOWF", "WF24", "WF29", "WF34", "WF39", "WF44", "WF49", "WF54", "WF59", "WF64"],
                       0:  [47121511, 41735415, 47121511, 47121511, 47121511, 47121511, 47121511, 47121511, 47121511, 47121511],
                       5:  [51910402, 42803181, 46087206, 51910402, 51910402, 51910402, 51910402, 51910402, 51910402, 51910402],
                       10: [56980196, 44444962, 47529288, 50318851, 56980196, 56980196, 56980196, 56980196, 56980196, 56980196],
                       15: [62188494, 46070930, 49431594, 51369360, 54705984, 62188494, 62188494, 62188494, 62188494, 62188494],
                       20: [67471620, 47886448, 51394522, 52923693, 55288959, 59280747, 67471620, 67471620, 67471620, 67471620],
                       25: [72737463, 49849730, 53498553, 54410660, 56308804, 59346363, 63860571, 72737463, 72737463, 72737463],
                       30: [77914663, 52041020, 55821834, 56144648, 57221106, 59738735, 63657885, 68376796, 77914663, 77914663],
                       35: [82865616, 54425580, 58271719, 58103287, 58300674, 60089892, 63757500, 68087556, 72609031, 82865616],
                       40: [87630606, 56892290, 60792791, 60345526, 59755082, 60571424, 63810526, 68038155, 72020578, 76662523]}).set_index("WF")

c_p_df = pd.DataFrame({"WF": ["NOWF", "WF24", "WF29", "WF34", "WF39", "WF44", "WF49", "WF54", "WF59", "WF64"],
                       0:  [47118283, 41732572, 47118283, 47118283, 47118283, 47118283, 47118283, 47118283, 47118283, 47118283],
                       5:  [51905750, 42799733, 46083189, 51905750, 51905750, 51905750, 51905750, 51905750, 51905750, 51905750],
                       10: [56974474, 44440852, 47526026, 50314545, 56974474, 56974474, 56974474, 56974474, 56974474, 56974474],
                       15: [62181700, 46065930, 49428959, 51366414, 54700688, 62181700, 62181700, 62181700, 62181700, 62181700],
                       20: [67463499, 47880443, 51392319, 52922112, 55284740, 59274804, 67463499, 67463499, 67463499, 67463499],
                       25: [72727523, 49842731, 53496814, 54410230, 56305315, 59343083, 63852758, 72727523, 72727523, 72727523],
                       30: [77903457, 52033086, 55820453, 56144838, 57218453, 59738276, 63650989, 68368026, 77903457, 77903457],
                       35: [82853536, 54416620, 58270716, 58104052, 58298768, 60092432, 63751007, 68079148, 72599659, 82853536],
                       40: [87617543, 56882588, 60792249, 60346532, 59753532, 60576835, 63804388, 68029603, 72011353, 76652291]}).set_index("WF")

ABP = 0.028
delta_t = 5
###########################################

print(f"Baseline carbon stocks\n {c_b_df}")
#print(f"Project carbon stocks\n {c_p_df}")

# current method
# temporarily use a placeholder of 1 for the NOWF values
naive_probs = pd.DataFrame.from_dict({interval - 5: [1] + [ABP] + [ABP * 5 if wf_yr < (interval -5) / 5 else 0 for wf_yr in np.arange(8)] for interval in np.arange(5, 50, 5)})
naive_probs.iloc[0] = 1 - naive_probs.iloc[1:].sum()
# crudely update the NOWF values so that prob(NOWF) can't be negative
naive_probs.iloc[0][naive_probs.iloc[0] < 0] = 0

# Poisson process method
# this is part of the trapezoidal approximation recommended by Val
def trapezoidal_weight(k, n, nu_dt = ABP * delta_t):
    return np.exp(- k * nu_dt) * nu_dt * 0.5 * (
        (1 if (k > 0) else 0) +
        (1 if (k < n) else 0)
    )
# a more precise approximation recommended and implemented by Val
def simpson_3_8_weight(k, n, nu_dt = ABP * delta_t):
    assert n % 2 == 0, "n must be even"
    return np.exp(- k * nu_dt) * nu_dt * (
        2 +
        (2 if (k % 2 == 1) else 0) +
        (-1 if (k == 0) else 0) +
        (-1 if (k == n) else 0)
    ) / 3

# preserve NOWF and WF probabilities in a single dict (following REM notation for time periods)
poisson_probs = pd.DataFrame.from_dict({n * delta_t: [np.exp(-ABP * n * delta_t)] + [
    (simpson_3_8_weight(wf_yr, n) if n % 2 == 0 else trapezoidal_weight(wf_yr, n))
    if wf_yr <= n else 0
    for wf_yr in np.arange(9)
 ] for n in np.arange(9)})
#poisson_probs = pd.DataFrame.from_dict({interval - 5: [np.exp(-ABP * (interval-5))] + [
#    trapezoidal_weight(wf_yr, interval/delta_t - 1)
#    if wf_yr * delta_t < interval else 0
#    for wf_yr in np.arange(9)
# ] for interval in np.arange(5, 50, delta_t)})
# normalize these probabilities; even w/o normalization the overestimation of even the worst one (yr 40) is very small (1.0011)
# normalization is justifiable because overestimation is an expected consequence of using the trapezoidal approximation
poisson_probs = poisson_probs / poisson_probs.sum()

def abridged_FMU_calcs(probs: pd.DataFrame, c_b_df: pd.DataFrame, c_p_df: pd.DataFrame, ABP: float, delta_t: int):
    '''
    Print a bunch of intermediate outputs and then the final FMU values.
    '''

    expectation_wts = probs
    expectation_wts["WF"] = ["NOWF", "WF24", "WF29", "WF34", "WF39", "WF44", "WF49", "WF54", "WF59" , "WF64"]
    expectation_wts = expectation_wts.set_index("WF")

    print(f"Expectation weights\n {expectation_wts}")
    print(f"Shouldn't each of these sum to 1?\n {expectation_wts.sum()}")

    # baseline and project expected carbon stocks; we only need the diagonals
    c_b_exp = pd.Series(np.diag(c_b_df.T.dot(expectation_wts)))
    print(f"Expected Baseline carbon stocks\n {c_b_exp}")
    c_p_exp = pd.Series(np.diag(c_p_df.T.dot(expectation_wts)))
    print(f"Expected Project carbon stocks\n {c_p_exp}")

    net_c_stocks = c_p_exp - c_b_exp
    print(f"Net expected carbon stocks\n {net_c_stocks}")

    # final calculations; all that matters is the final (gross) FMU value
    fmu = net_emissions + net_c_stocks[1:]
    print(f"FMU values\n {fmu}")

#abridged_FMU_calcs(naive_probs, c_b_df, c_p_df, ABP, delta_t) # FMU = 14,444
abridged_FMU_calcs(poisson_probs, c_b_df, c_p_df, ABP, delta_t) # FMU = 12,542 (12,541 w/o normalization)
#+end_src

#+RESULTS:
#+begin_example
Baseline carbon stocks
              0         5        10        15        20        25        30        35        40
WF
NOWF  47121511  51910402  56980196  62188494  67471620  72737463  77914663  82865616  87630606
WF24  41735415  42803181  44444962  46070930  47886448  49849730  52041020  54425580  56892290
WF29  47121511  46087206  47529288  49431594  51394522  53498553  55821834  58271719  60792791
WF34  47121511  51910402  50318851  51369360  52923693  54410660  56144648  58103287  60345526
WF39  47121511  51910402  56980196  54705984  55288959  56308804  57221106  58300674  59755082
WF44  47121511  51910402  56980196  62188494  59280747  59346363  59738735  60089892  60571424
WF49  47121511  51910402  56980196  62188494  67471620  63860571  63657885  63757500  63810526
WF54  47121511  51910402  56980196  62188494  67471620  72737463  68376796  68087556  68038155
WF59  47121511  51910402  56980196  62188494  67471620  72737463  77914663  72609031  72020578
WF64  47121511  51910402  56980196  62188494  67471620  72737463  77914663  82865616  76662523
Expectation weights
         0         5        10        15        20        25        30        35        40
WF
NOWF  1.0  0.869173  0.755783  0.656679  0.571209  0.496177  0.431710  0.374929  0.326279
WF24  0.0  0.069985  0.046667  0.069961  0.046667  0.069943  0.046667  0.069929  0.046667
WF29  0.0  0.060842  0.162280  0.121642  0.162280  0.121610  0.162280  0.121586  0.162280
WF34  0.0  0.000000  0.035270  0.105751  0.070540  0.105723  0.070540  0.105702  0.070540
WF39  0.0  0.000000  0.000000  0.045968  0.122649  0.091911  0.122649  0.091893  0.122649
WF44  0.0  0.000000  0.000000  0.000000  0.026656  0.079904  0.053313  0.079888  0.053313
WF49  0.0  0.000000  0.000000  0.000000  0.000000  0.034732  0.092696  0.069451  0.092696
WF54  0.0  0.000000  0.000000  0.000000  0.000000  0.000000  0.020146  0.060378  0.040293
WF59  0.0  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.026245  0.070058
WF64  0.0  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.000000  0.015226
Shouldn't each of these sum to 1?
 0     1.0
5     1.0
10    1.0
15    1.0
20    1.0
25    1.0
30    1.0
35    1.0
40    1.0
dtype: float64
Expected Baseline carbon stocks
 0    4.712151e+07
1    5.091874e+07
2    5.462658e+07
3    5.802104e+07
4    6.120992e+07
5    6.397114e+07
6    6.656561e+07
7    6.870376e+07
8    7.079667e+07
dtype: float64
Expected Project carbon stocks
 0    4.711828e+07
1    5.091421e+07
2    5.462138e+07
3    5.801535e+07
4    6.120386e+07
5    6.396461e+07
6    6.655903e+07
7    6.869739e+07
8    7.079032e+07
dtype: float64
Net expected carbon stocks
 0   -3228.000000
1   -4529.103242
2   -5197.622115
3   -5686.793734
4   -6063.917497
5   -6532.598181
6   -6584.473405
7   -6373.592493
8   -6349.201702
dtype: float64
FMU values
 1    -3308.103242
2    -3842.622115
3    -2292.793734
4     -158.917497
5     3006.401819
6     5715.526595
7     9244.407507
8    12541.798298
dtype: float64
#+end_example
